# 索引

# 5.1 InnoDB存储引擎的索引

  * B+索引
  
  * 全文索引
  
  * Hash索引：查询单条数据可以使用，但是不可受程序员控制。
  
  InnoDB索引提供的Hash索引是自适应的，InnoDB会根据表的使用情况自动为表生成hash索引。
  
  B+索引是传统意义的索引，这时目前关系数据库中最为常见有效的索引，根据键值快速找到索引。另外，B+索引并不能找到一个具体行，而是找到被查找数据的页，然后数据库把页读到内存，在内存中查找。
  
# 5.2 数据结构和算法
### 5.2.1 B+树
        1.非叶子根至少两个子树
        2.非根非叶节点有[m/2,m]个index
        3.叶子有上层元素个value
        4.叶子节点使用链表连接，方便查找
        5.减少了IO次数
        6.对于范围查找，不需要回溯
        7.查询更稳定
        
  数据库中B+树的高度一般在2-4层，查找一次最多只需要2-4次IO。
  
  B+树索引分为聚集索引和辅助索引。
  
### 5.2.2 聚集索引
  聚集索引就是按照每个表的主键构成一颗B+树，叶子节点存放整张表的行记录数据。并且，叶子节点通过双向链表连接了起来。
  
  由于实际的数据页只能按照一颗B+树排序，每个表只能拥有一个聚集索引。
  
  聚集索引由于定义了数据的逻辑顺序，因此，适合范围查找和排序查找。
  
### 5.2.3 辅助索引
  辅助索引，也就是非聚集索引，也是通过B+树实现的，聚集索引存放行的所有数据，辅助索引不同，叶子节点不包括行记录的全部数据，只包括键和一个查找对应行记录的书签，在InnoDB中这个书签就是记录的主键。
  
  辅助索引的存在不会影响聚集索引，聚集索引构成的B+树是数据实际存储的形式。，而辅助索引只是用于加速数据的查找。
  
  辅助索引的查找方式：通过辅助索引查找到对应的主键，最后在聚集索引中使用主键获取对应的行记录，这也是通常情况下行记录的查找方式。
  
### 5.2.4 联合索引

    create table t(
        a int,
        b int
        primary key (a),
        key idx_A_B (a,b)
    )  
  联合索引是指对多个列进行索引，与上面的不同仅仅是联合索引有多个索引列。
  
  最左匹配:联合索引也是一颗B+树，不同的是联合索引的键值是多个，排序按照（a，b，c）依次顺序排列。对于上面的表，select * from table where a=xxx and
  b = xxx，显然可以使用（a，b）索引来查找，对于单个的select * from table where a=xxx，也可以使用（a，b）来查找。但对于select * from
  table where b=xxx，就不可以使用（a，b）了。因此排序结果不是按照b的优先排列进行的。
  
  
# 5.2.5 覆盖索引
  聚集索引十分高效，但是辅助索引必须通过两次查找B+树才能得到结果，这种行为成为 **回表**。回表会导致多次IO，为了减少MySQL的IO，使用覆盖索引可以实现。
  
# 5.3 索引失效

  * 1.like 以%开头，索引无效；当like前缀没有%，后缀有%时，索引有效。
  * 2.or语句前后没有同时使用索引。当or左右查询字段只有一个是索引，该索引失效，只有当or左右查询字段均为索引时，才会生效
  * 3.不符合最左匹配
  * 4.在索引字段上使用not，<>，!=。不等于操作符是永远不会用到索引的，因此对它的处理只会产生全表扫描。 优化方法： key<>0 改为 key>0 or key<0。
  * 对索引字段进行计算操作、字段上使用函数。（索引为 emp(ename,empno,sal)）
 
 可以使用explain分析，如果key对应为null，那就是没有使用到索引或者索引失效。
  
  
# 5.4 索引优化
  
  
# 5.5 最左匹配
  对于联合索引，一个查询条件精确匹配索引最左的连续一列或者几列，就可以命中索引。
  
# 5.6 如何添加索引
  * 主键索引：ALTER TABLE `table_name` ADD PRIMARY KEY ( `column` ) 
  
  * 唯一索引：ALTER TABLE `table_name` ADD UNIQUE ( `column` ) 
  
  * 普通索引：ALTER TABLE `table_name` ADD INDEX index_name ( `column` )
  
  * 全文索引：ALTER TABLE `table_name` ADD FULLTEXT ( `column`)
  
  * 多列索引：ALTER TABLE `table_name` ADD INDEX index_name ( `column1`, `column2`, `column3` )        
  
  
# 5.7 哈希索引
  哈希索引就是采用一定的哈希算法，把键值换算成新的哈希值，检索时不需要类似B+树那样从根节点到叶子节点逐级查找，只需一次哈希算法即可立刻定位到相应的位置，速度非常快。
  
  但是不支持范围查找。
 
# 5.8 全文索引
  将存储在数据库的任意内容标记出来，方便查找。
  
  
# 5.9 InnoDB和MyISAM索引实现的区别


### MyISAM

1. 主键索引

MyISAM引擎使用B+树作为索引结果，叶节点的data域存放的是数据记录的地址。下图为MyISAM表的主索引，Col1为主键。

2. 辅助索引

在MyISAM中，主索引和辅助索引在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复。下图在Col2上建立一个辅助索引

### InnoDB

1. 主键索引

同样是B+树，实现方式却完全不同。InnoDB表数据文件本身就是一个索引结构，树的叶节点data域保存了完整的数据记录，这种索引叫做聚集索引。


2 辅助索引

InnoDB的所有辅助索引都引用主键作为data域。