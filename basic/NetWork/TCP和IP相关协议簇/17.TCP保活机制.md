# TCP保活机制

# 17.1 引言

对于已经建立好TCP连接的双方来说，不进行任何数据交换，双方没有任何一方意外断开连接或者主动断开连接，哪怕过去几个小时，几天，中间的路由器重启和崩溃，建立连接的双方依然会保持连接。

这就是由TCP保活机制来实现的，保活机制是一种在不影响数据流的情况下探测对方的方式，它由一个保活计时器来实现。当计时器被激发，连接一方就会发送一个保活探测报文，另一端接收报文也会回应一个ACK报文。

保活功能一般是为服务器应用程序提供的，服务器应用程序希望知道客户端是否崩溃或者离开，从而决定是否为客户端保持连接。利用TCP保活机制来探测离开的主机，有助于短时间的对话的建立。

# 17.2 描述

保活机制在默认情况下是关闭的。TCP连接的任何一端都可以请求打开这一功能。如果在一段时间（保活时间）内连接处于非活动状态，开启保活功能的一方
将向对方发送一个探测报文，如果接收端没有回应ACK，那么经过一定时间就会重复确认，直到达到一定次数，这时候主动探测的一方就会断开连接。

保活探测报文为一个空报文段（只有一字节），它的序列号等于对方主机发送的ACK报文的最大序列号减一。

TCP保活机制开启后，被探测的一方可能处于四种状态之一：

* 对方主机仍在工作，并且可以到达。这时候TCP响应正常，请求段就将保活计时器重置。

* 对方主机已经崩溃，包括已经关闭或者正在重启。这时，保活报文就不会收到响应，直到达到限定次数，如果请求段没有收到任何响应，那么这时候，它就认为对方主机已经关闭，连接就会被断开。

* 客户主机崩溃但是已经重启。在这种情况下，请求端会收到一个响应，但是这个响应是一个RST，请求段将会断开连接。

* 对方主机仍然在工作，但由于某些原因不能到达请求端。请求端无法区别这和状态2的区别，结果都是没有收到ACK。
