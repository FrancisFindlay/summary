# TCP超时重传

# 14.1 引言

TCP会对丢失的包进行重传，重传机制有两种，基于时间和基于确认信息。第二种往往更高效。

TCP发送数据时会设置一个定时器，计时器超时称为RTO，如果计时器超时仍然没有收到确认信息，就会引发超时重传。另外一种机制称为快速重传。通常发送在没有延时的情况下，若TCP累积确认无法返回新的ACK，就会认为丢包。

重传机制：

* 快速重传

* 超时重传

# 14.2 设置重传超时

TCP如果工作在静态环境中，设置RTO是一个很容易的事情。但是，TCP要适应不同环境，需要随着时间变化动态去设置RTO。

TCP怎么根据给定连接的RTT去设置RTO呢。TCP会在收到数据后返回确认信息，可以在该信息中携带一个字节的数据来测量传输该确认信息需要的时间，每个此类的测量结果称为RTT样本。
TCP根据一段时间的RTT样本来设置RTO，RTO设置得当是TCP性能保证的关键。RTO小于RTT，那么在网络中的重复数据就会增多，如果RTO大于RTT太多，那么性能就会下降。

每一个TCP连接的RTT都需要独立估算，并且重传计时器会对任何占用序列号的数据计时。

# 14.3 一些经典的设置RTO的方法

# 14.4 基于计时器的重传

一旦TCP发送端得到来基于时间变化的RTT测量值，就能根据此设置RTO，发送报文段时就根据RTO设置超时重传。在设定计时器之前，首先需要记录被计时的报文段的序号，如果及时收到了ACK，那么就取消计时器。其后的报文也依次类推。

如果在连接设定的RTO内，TCP没有收到ACK，那么就会触发超时重传。TCP将超时重传看作相当重要的事情，当发生了超时重传，就会降低发送速率来进行快速响应。

# 14.5 快速重传

快速重传机制基于接收端的反馈机制来引发重传，而非超时。

相比较于超时重传，快速重传更能及时有效修复丢包情况。典型的TCP同时实现了两者。

TCP在接受到失序报文时，TCP需要立即生成确认信息，失序情况表明来在后续数据到达前出现了丢段，也就是接收缓存出现了空缺。失序报文到达后，ACK立即返回，不能延迟发送，发送端维护一个ACK阈值，来决定数据包是丢失了还是延时到达了，通常，这个阈值是3。

快速重传算法可以概括为，TCP发送端在观测到至少dupthresh个重复ACK后，不需要等待超时计时器超时，就直接发送报文。

# 14.6 带选择确认的重传

TCP发送端的任务是通过重传丢失的数据来填补接收端缓存的空缺，但也要尽可能保证不重复发送已经正确收到的数据。使用SACK选项，一个ACK可以包含三四个告知失序数据的SACK信息。每个SACK包含32位的序列号。

SACK选项指定n个块的长度为8n+2字节，因此40字节可以包含最多4个块。通常SACK会和TSOPT一起使用，因此需要额外的10字节，这意味着SACK在每个ACK中只能包含3三个块。


# 14.7 伪超时和重传




# 14.8 包失序和包重复



