# 流量控制

# 16.1 引言

TCP的流量控制通过滑动窗口协议来实现，它可以动态调整窗口大小来控制发送方的操作，确保接收端不会溢出。

# 16.2 延时确认

在许多情况下，TCP并不对每个到来的数据报都返回ACK，利用TCP的累积ACK字段就能实现该功能。累积确认可以允许TCP延迟一段时间发送ACK，以便将ACK和相同方向上需要传输的数据合并。

显然，TCP不能无限期延时ACK，这样会让接收方误以为丢包。TCP实现ACK延迟的时延应该小于500ms，实践中最大取200ms。

采用延时ACK的方法可以减少ACK的发送数量，一定程度减轻网络延迟。

# 16.3 流量控制和窗口管理

### 16.3.1 滑动窗口

TCP连接的每一方都可以收发数据。连接的收发数据量是通过一组窗口结构来维护。每个TCP连接的两端都维护一个发送窗口结构和接收窗口结构。

TCP以字节为单位（非包）维护其窗口结构。随着接受到ACK，窗口向未发送数据的方向移动。可用三个术语来描述窗口左右边界的运动。

* 关闭：窗口左边界移动向右移动，当已发送数据得到ACK确认时，窗口会减少。

* 打开：窗口右边界右移，窗口变大。

* 收缩：窗口右边界左移。

每个TCP报文都包含ACK号和窗口通告信息，TCP发送端可以根据此调节窗口大小。当得到的ACK号增大，而窗口大小保持不变的时候，我们就说窗口在滑动了。

但如果得到的ACK号增大而窗口却不断减少，直到窗口大小为0，就称之为零窗口。此时发送端不能再发送数据，这种情况下，TCP会探测对方的窗口大小，伺机增大窗口。

接收端也用同样的方法维护了一个窗口，对于接收端来说，到达序列号小于左窗口的边界，就认为这是重复数据而丢失，超过右边界的，同样丢弃。只有当到达数据序列号等于左边界，才会被接受。
而对于选择确认ACK来说，使用SACK选项，处于窗口内的报文也可以被接受，但仍然只有等于左边界，窗口才会右移。

### 16.3.2 零窗口和TCP持续计时器

TCP通过接收端的通知窗口来实现流量控制。当接收方的窗口变为0时，就需要阻止发送方继续发送，直到窗口大小恢复到了非零。当接收端重新获得窗口有效大小时，就会给发送端发送一个纯ACK报文，称为窗口更新。

如果一个包含窗口更新的ACK丢失，通信双方就会一直处于等待状态。为了防止这种情况，发送端会采用一个计时器间接的查询接收端，查看其窗口的大小。持续计时器会让接收端强制返回ACK。

RFC建议在一个1个RTO后发送第一个窗口探测，随后以指数时间间隔发送。

### 16.4 糊涂窗口

有可能，每一次发送的报文包含的有效数据都非常少，这样，就增多了需要传输的报文数，降低了效率。

因此，TCP规定：

* 对于接收端来说，在窗口可以增长到窗口缓存一半大小或者一个全长的MSS之前，不对发送方进行通知。

* 对于发送方来说，不应发送小的报文段，全长的报文可以发送，数据报长度大小大于通告过的接收端窗口大小的一半可以发送。

### 16.5 自动调优

