# 拥塞控制

# 15.1 引言

拥塞控制是数据传输最重要的，是双方都需要执行的一系列操作，这些操作防止了网络因为通信负载而瘫痪。基本方法是当有理由认为网络处于或者即将处于拥塞状态时减缓TCP的传输。

路由器无法处理高速率到达的流量而被迫丢弃数据信息的现象就称为拥塞。即使只有一个连接，也可能使多个路由器处于拥塞。如果不采取措施，网络性能就会大大受损。

# 15.2 TCP拥塞检测

针对丢包现象，TCP采取的首要机制是重传，包括超时重传和快速重传。当网络处于拥塞时，TCP连接就需要重传多个数据报，这无疑是火上浇油。

因此，当拥塞出现时，我们可以减缓TCP发送端的发送速率。对于网络来说，预测会不会发生拥塞是非常困难的事，因此，大多数情况只有真正发生了拥塞控制，才会进行相应的处理。通常情况，宣告发生拥塞的标志就是看是否有丢包的情况发生。

讨论快速重传时，我们知道了发生丢包时TCP的任务是重传这些数据报。那么，观测到丢包TCP还做了哪些工作呢。

# 15.3 减缓TCP发送速率

发送方维护了一个窗口控制变量用来保证发送窗口的大小不超过网络传输能力和接收端的接收能力。也就是发送窗口的大小：

*  W = MIN(CWND,AWND)

其中，CWND为拥塞窗口，AWND为接收窗口。

这样看起来合乎逻辑，但是仍然有很多问题。网络和接收端的情况会随着时间变化，awnd和cwnd的大小也会变化。另外，由于衡量拥塞没有明显的指标，cwnd的大小也难以确定。

因此，这三个变量就都需要根据经验设定并动态调节。W的大小不能过大也不能太小。我们希望其接近带宽延迟积（BDP），也可以称为最佳窗口大小。a

# 15.4 经典算法

### 15.4.1 慢启动

当一个新的TCP连接建立或者检测到由重传超时导致的丢包时，需要执行慢启动。TCP发送端长时间处于空闲状态也可能调用慢启动算法。

慢启动的目的是，使TCP在用拥塞避免探寻更多可用带宽之前得到cwnd值。TCP以一定数量的数据段开始慢启动，称为初始窗口。初始窗口大小一般为1个单位的SMSS（发送方的最大段大小），而SMSS的大小一般为接收方的MSS和路径MTU的最小值。

发送方每接受一个ACK，cwnd的值会增加为原来的二倍，接着发送两个数据段，并以此类推。

如果接收方的窗口非常大，这时候cwnd就会成为主要的影响发送速率的因素，cwnd在经过若干次增长后会变得非常大，进而导致网络瘫痪。当发生上述情况时，cwnd的值就会降为原来的一半。

### 15.4.2 拥塞避免

上面所说，当cwnd增长到一定程度导致网络不稳定时，当前cwnd就是阈值。而达到cwnd后，TCP还干了什么呢，TCP会进入拥塞避免算法，cwnd的增长就会变成线性增长。

* CWNDn+1 = CWNDn + SMSS * SMSS / CWNDn 

通常，每次收到ACK，cwnd就会增长一个特定值（大部分情况为1）。

### 15.4.3 慢启动和拥塞避免的选择

我们提到了慢启动阈值，这个值就是慢启动或者拥塞避免的分界线。当cwnd大于阈值时，执行拥塞避免；当cwnd小于阈值时，执行慢启动。

这个过程是这样的：

首先TCP连接建立后，进行慢启动算法。cwnd不断增加，然后遇到网络不稳定，把当前的cwnd设为阈值。之后，启动拥塞避免算法，每次的cwnd线性增加。这时，如果出现丢包，就将阈值设为当前cwnd的一半，然后将cwndw置为1，再次执行慢启动。


