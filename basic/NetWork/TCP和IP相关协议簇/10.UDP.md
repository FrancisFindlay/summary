# UDP 用户数据报协议

# 10.1 引言

UDP不面向连接，不提供差错纠正，队列消息处理，重复消除，流量控制和拥塞控制。UDP提供差错检测，有其校验和。如果要保证数据正确传输，应用层必须自己实现这些功能。

# 10.2 UDP头部

UDP头部一般是8字节以及负载数据。8字节的头部包括原端口号，目的端口号各两个字节，长度两个字节以及2字节的校验和。

端口号用来辨别通信的进程。不同的传输层协议，端口号是独立的。TCP端口号只能被TCP使用，UDP端口号只能被UDP使用。这样，不同的服务器就可以使用相同的端口号和IP地址，只要它们传输层协议不同。

长度是头部和数据段的总长度，这个字段最小为8。发送0字节的负载数据是允许的，但是非常少见。另外，UDP的长度字段其实是多余的，因为IPV4头部包含了数据报的总长度，因此，一个UDP/IPV4数据报的长度等于IPV4数据报总长度减去IPV4头部的总长度。

# 10.3 UDP检验和

# 10.4 IP分片

IP层接受到一个要发送的IP数据报时，它会判断数据报应该从哪个接口发送以及要求的MTU是多少。如果IP数据报太大，那么就进行分片。IPV4的分片可以在源主机进行，也可以在任何一个中间路由器进行。

当一个IP数据报被分片了，直到它达到目的地才会被重组。因此，第一，只在目的地重组可以减轻路由器负载；第二，不同的IP分片可能会经过不同的路径到达目的地，如果这样，中间路由器就没有能力重组数据报。

对于分片，应该尽量避免。因为一个分片丢失，就需要重传整个分组。在一个以太网里，帧的有效负载最大为1500字节，采用UDP传输，最大数据量为1472字节。如果数据段都小于1472字节，那就可以避免分片。

# 10.5 重组超时

一个数据报的任何一个分片首先到达，IP层就启动一个路由器。如果不这样，一个不完整的数据报就一直存在于目的主机的缓存里，导致缓存用尽。

当超时时，发送方就会回送一个ICMP数据报，通知发送方数据丢失。一般超时时间为30s或者60s。

# 10.6 最大UDP传输长度

理论上，一个UDP最大长度为65535字节，除去20字节的IPV4头部和8字节的UDP头部，剩下65507字节留给一个UDP数据报的用户数据。然而，有两个原因使得这些大小的满额数据报不能被传输。第一，系统的本地协议可能有一些限制（链路层实现）；第二，接受应用程序可能没能力去接受大额的数据报。

### 10.6.1 实现限制

可以通过 setsocketpt（）来设置UDP数据报大小的值。

之前提过，一个主机重组时要提供至少576字节（X.25的MTU）的IPV4数据报。很多UDP程序被设计成限制数据报大小在512字节或者更小。